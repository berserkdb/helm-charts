{{ include "berserk-common.configmap.metadata" . }}
data:
  config.yaml: |
    extensions:
      file_storage:
        directory: /var/lib/tjalfe

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: "0.0.0.0:{{ .Values.service.ports.otlpGrpc }}"
            # Allow invalid UTF-8 in string fields (e.g., journald binary data)
            lax_utf8: true
          http:
            endpoint: "0.0.0.0:{{ .Values.service.ports.otlpHttp }}"
            # Allow invalid UTF-8 in string fields (e.g., journald binary data)
            lax_utf8: true
    
    processors:
      batch:
        send_batch_size: 1024
        timeout: 10s
        send_batch_max_size: 2048
      # Kubernetes attributes enrichment
      k8sattributes:
        auth_type: serviceAccount
        passthrough: {{ .Values.config.k8sAttributes.passthrough | default true }}
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.pod.name
            - k8s.pod.uid
            - k8s.deployment.name
            - k8s.daemonset.name
            - k8s.statefulset.name
            - k8s.node.name
            - k8s.container.name
          labels:
            - tag_name: app
              key: app
              from: pod
            - tag_name: version
              key: version
              from: pod
        pod_association:
          - sources:
              - from: resource_attribute
                name: k8s.pod.ip
          - sources:
              - from: resource_attribute
                name: k8s.pod.uid
          - sources:
              - from: connection



    exporters:
      berserk:
        meta_endpoint: {{ .Values.config.metaEndpoint | quote }}
        s3_access_key: "${env:AWS_ACCESS_KEY_ID}"
        s3_secret_key: "${env:AWS_SECRET_ACCESS_KEY}"
        s3_region: {{ .Values.config.s3Region | quote }}
        buffer_size: 100
        keep_alive_interval_secs: 120
        combined_signals: true        

      debug:
        verbosity: basic
        sampling_initial: 5
        sampling_thereafter: 200

    service:
      extensions: [file_storage]

      pipelines:
        logs:
          receivers: [otlp]
          processors: [k8sattributes, batch]
          exporters: [berserk]

        metrics:
          receivers: [otlp]
          processors: [k8sattributes, batch]
          exporters: [berserk]

        traces:
          receivers: [otlp]
          processors: [k8sattributes, batch]
          exporters: [berserk]

      telemetry:
        level: {{ .Values.config.observability.logLevel | quote }}
        address: "0.0.0.0:{{ .Values.service.ports.telemetry }}"
